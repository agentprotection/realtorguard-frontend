<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-top:14px;
box-shadow:0 2px 8px rgba(0,0,0,.08)}
input,select,button,textarea{
  width:100%;padding:14px;margin-top:10px;
  border-radius:12px;font-size:16px;box-sizing:border-box
}
button{border:none;font-weight:900;background:#111;color:#fff}
.secondary{background:#fff;color:#111;border:1px solid #ccc}
.status{margin-top:8px;font-weight:900}
.pending{color:#6b7280}
.accepted{color:#2563eb}
.inroute{color:#16a34a}
.expired{color:#dc2626}
.note{font-size:13px;color:#6b7280;margin-top:8px}
</style>
</head>

<body>
<div class="wrap">
<h2>Agent Dashboard</h2>

<!-- FORM -->
<div class="card">
  <input id="agentName" placeholder="Agent Name">

  <input id="address" placeholder="Property Address">
  <input id="city" placeholder="City">

  <select id="state">
    <option value="">State</option>
    <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
    <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
    <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
    <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
    <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
    <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
    <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
    <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
    <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
    <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
    <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
    <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
    <option>WI</option><option>WY</option>
  </select>

  <input id="zip" placeholder="ZIP Code">

  <select id="timezone">
    <option value="">Time Zone</option>
    <option>Eastern</option>
    <option>Central</option>
    <option>Mountain</option>
    <option>Pacific</option>
  </select>

  <select id="visitType">
    <option value="">Visit Type</option>
    <option>Open House</option>
    <option>Showing</option>
    <option>Other</option>
  </select>

  <textarea id="otherDesc" placeholder="Description" style="display:none"></textarea>

  <!-- TEXT inputs so placeholders ALWAYS show -->
  <input id="date" placeholder="Date (YYYY-MM-DD)">
  <input id="time" placeholder="Time (HH:MM AM/PM)">

  <select id="duration">
    <option value="">Duration</option>
    <option value="30">30 minutes</option>
    <option value="60">60 minutes</option>
    <option value="90">90 minutes</option>
    <option value="120">120 minutes</option>
    <option value="150">150 minutes</option>
    <option value="180">180 minutes</option>
    <option value="210">210 minutes</option>
    <option value="240">240 minutes</option>
  </select>

  <button id="btnRequest">Request Observer</button>
  <button id="btnFormRefresh" class="secondary">Refresh</button>

  <div class="note" id="msg"></div>
</div>

<!-- LIST CONTROLS -->
<div class="card">
  <button id="btnDeleteExpired" class="secondary">Delete Expired Requests</button>
  <button id="btnListRefresh" class="secondary">Refresh List</button>
</div>

<!-- REQUEST LIST -->
<div class="card">
  <div id="list"></div>
</div>
</div>

<script>
const REQ_KEY="rg_agent_requests_v1";
const STATUS_KEY="rg_request_status_v3";
const $=id=>document.getElementById(id);

const loadReq=()=>JSON.parse(localStorage.getItem(REQ_KEY))||[];
const saveReq=r=>localStorage.setItem(REQ_KEY,JSON.stringify(r));
const loadStatus=()=>JSON.parse(localStorage.getItem(STATUS_KEY))||{};
const saveStatus=s=>localStorage.setItem(STATUS_KEY,JSON.stringify(s));

function showMsg(t){$("msg").textContent=t||""}

function to24h(t){
  const m=t.trim().toUpperCase().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/);
  if(!m) return null;
  let h=parseInt(m[1]); const mm=m[2];
  if(m[3]==="PM"&&h!==12)h+=12;
  if(m[3]==="AM"&&h===12)h=0;
  return String(h).padStart(2,"0")+":"+mm;
}

function scheduledAt(r){return new Date(`${r.date}T${r.time24}`)}

function submit(){
  showMsg("");
  const data={
    agentName:$("agentName").value.trim(),
    address:$("address").value.trim(),
    city:$("city").value.trim(),
    state:$("state").value,
    zip:$("zip").value.trim(),
    timezone:$("timezone").value,
    visitType:$("visitType").value,
    otherDesc:$("otherDesc").value.trim(),
    date:$("date").value.trim(),
    time:$("time").value.trim(),
    duration:$("duration").value
  };

  if(Object.values(data).some(v=>!v)&&!(data.visitType!=="Other"&&data.otherDesc==="")){
    showMsg("Complete required fields"); return;
  }

  const time24=to24h(data.time);
  if(!time24){showMsg("Time format HH:MM AM/PM");return;}

  const reqs=loadReq();
  reqs.push({
    id:Date.now().toString(),
    ...data,
    time24
  });
  saveReq(reqs);
  render();
  showMsg("Saved");
}

function refreshForm(){
  document.querySelectorAll("input,select,textarea").forEach(e=>e.value="");
  $("otherDesc").style.display="none";
  showMsg("");
}

function resolve(r){
  const s=loadStatus()[r.id];
  const now=Date.now();
  const sched=scheduledAt(r).getTime();
  if(s?.status==="in_route")return{t:"In Route",c:"inroute"};
  if(s?.status==="accepted")return{t:"Accepted",c:"accepted"};
  if(now>sched)return{t:"Expired",c:"expired"};
  return{t:"Pending",c:"pending"};
}

function cancel(id){
  saveReq(loadReq().filter(r=>r.id!==id));
  const st=loadStatus(); st[id]={status:"canceled_by_agent",time:Date.now()};
  saveStatus(st); render();
}

function del(id){
  saveReq(loadReq().filter(r=>r.id!==id));
  const st=loadStatus(); delete st[id];
  saveStatus(st); render();
}

function deleteExpired(){
  const now=Date.now();
  const st=loadStatus();
  saveReq(loadReq().filter(r=>{
    if(st[r.id]?.status==="accepted")return true;
    if(st[r.id]?.status==="in_route")return true;
    return scheduledAt(r).getTime()>now;
  }));
  render();
}

function render(){
  $("list").innerHTML="";
  loadReq().forEach(r=>{
    const s=resolve(r);
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <b>${r.address}, ${r.city}, ${r.state} ${r.zip}</b>
      <div>${r.date} ${r.time}</div>
      <div class="status ${s.c}">${s.t}</div>
      ${s.t==="Expired"
        ? `<button class="secondary" data-del="${r.id}">Delete</button>`
        : `<button class="secondary" data-cancel="${r.id}">Cancel</button>`}
    `;
    $("list").appendChild(d);
  });

  document.querySelectorAll("[data-cancel]").forEach(b=>b.onclick=()=>cancel(b.dataset.cancel));
  document.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>del(b.dataset.del));
}

document.addEventListener("DOMContentLoaded",()=>{
  $("visitType").onchange=()=>{$("otherDesc").style.display=$("visitType").value==="Other"?"block":"none"};
  $("btnRequest").onclick=submit;
  $("btnFormRefresh").onclick=refreshForm;
  $("btnDeleteExpired").onclick=deleteExpired;
  $("btnListRefresh").onclick=render;
  render();
});
</script>
</body>
</html>
