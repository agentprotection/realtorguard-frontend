<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-top:14px;
box-shadow:0 2px 8px rgba(0,0,0,.08)}
input,select,button{
  width:100%;padding:14px;margin-top:10px;border-radius:12px;font-size:16px
}
button{border:none;font-weight:900;background:#111;color:#fff}
.secondary{background:#fff;color:#111;border:1px solid #ccc}
.status{margin-top:8px;font-weight:900}
.pending{color:#6b7280}
.accepted{color:#2563eb}
.inroute{color:#16a34a}
.expired{color:#dc2626}
</style>
</head>

<body>
<div class="wrap">
<h2>Agent Dashboard</h2>

<!-- AGENT FORM (UNCHANGED) -->
<div class="card">
  <input id="agentName" placeholder="Agent Name">
  <input id="address" placeholder="Property Address">
  <input id="city" placeholder="City">
  <select id="state">
    <option value="">State</option>
    <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
    <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
    <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
    <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
    <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
    <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
    <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
    <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
    <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
    <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
    <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
    <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
    <option>WI</option><option>WY</option>
  </select>
  <input id="date" type="date">
  <input id="time" type="time">
  <button onclick="submitRequest()">Request Observer</button>
</div>

<!-- DELETE EXPIRED (NEW, SIMPLE) -->
<div class="card">
  <button class="secondary" onclick="deleteExpiredRequests()">
    Delete Expired Requests
  </button>
</div>

<!-- REQUEST LIST -->
<div class="card">
  <div id="list"></div>
</div>

</div>

<script>
/* ===== STORAGE KEYS (MATCH OBSERVER) ===== */
const REQ_KEY = "rg_agent_requests_v1";
const STATUS_KEY = "rg_request_status_v3";

/* ===== HELPERS ===== */
const loadReq = () => JSON.parse(localStorage.getItem(REQ_KEY)) || [];
const saveReq = r => localStorage.setItem(REQ_KEY, JSON.stringify(r));
const loadStatus = () => JSON.parse(localStorage.getItem(STATUS_KEY)) || {};

function scheduledAt(r){
  return new Date(`${r.date}T${r.time}`);
}

/* ===== SUBMIT REQUEST ===== */
function submitRequest(){
  if(!address.value || !date.value || !time.value){
    alert("Complete the form");
    return;
  }

  const reqs = loadReq();
  reqs.push({
    id: Date.now().toString(),
    agentName: agentName.value,
    address: `${address.value}, ${city.value}, ${state.value}`,
    date: date.value,
    time: time.value
  });

  saveReq(reqs);
  render();
}

/* ===== STATUS RESOLUTION (FIXES PENDING ISSUE) ===== */
function resolveStatus(r){
  const stat = loadStatus()[r.id];
  const now = Date.now();
  const sched = scheduledAt(r);

  if(stat?.status === "in_route")
    return {t:"In Route", c:"inroute"};

  if(stat?.status === "accepted")
    return {t:"Accepted", c:"accepted"};

  if(now > sched)
    return {t:"Expired", c:"expired"};

  return {t:"Pending", c:"pending"};
}

/* ===== DELETE EXPIRED (WORKING) ===== */
function deleteExpiredRequests(){
  const now = Date.now();
  const statusMap = loadStatus();

  const cleaned = loadReq().filter(r=>{
    if(statusMap[r.id]) return true; // keep accepted / in-route
    return scheduledAt(r) > now;
  });

  saveReq(cleaned);
  render();
}

/* ===== RENDER (LIVE SYNC) ===== */
function render(){
  list.innerHTML = "";
  loadReq().forEach(r=>{
    const s = resolveStatus(r);
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <b>${r.address}</b>
      <div>${r.date} ${r.time}</div>
      <div class="status ${s.c}">${s.t}</div>
    `;
    list.appendChild(card);
  });
}

setInterval(render, 1000);
render();
</script>
</body>
</html>
