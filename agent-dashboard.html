<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Dashboard | Realtor Guard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f4f4f4; }
    .wrap { max-width: 650px; margin: 0 auto; padding: 16px; }
    h1 { margin: 8px 0 14px; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    label { display:block; font-weight:900; margin-top:12px; font-size:14px; }
    input, select, textarea {
      width:100%; padding:12px; margin-top:6px;
      border-radius:10px; border:1px solid #ccc; font-size:16px; box-sizing:border-box;
    }
    textarea { resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button {
      width:100%; margin-top:16px; padding:14px; font-size:18px; font-weight:900;
      border:none; border-radius:12px; background:#111; color:#fff; cursor:pointer;
    }
    .secondary { background:#fff; color:#111; border:1px solid #ccc; }
    .danger { background:#b00020; }
    .hidden { display:none; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#eee; }
    .pillGreen { background:#e7ffe7; border:1px solid #bff0bf; color:#145214; }
    .pillRed { background:#ffecec; border:1px solid #ffb3b3; color:#7a0000; }
    .muted { color:#666; font-size:13px; margin-top:6px; }
    .req { background:#fff; border-radius:14px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); margin-top:12px; }
    hr { border:none; border-top:1px solid #eee; margin: 16px 0; }
    a { color:#0b63ff; font-weight:900; text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Request an Observer</h1>

    <div id="formScreen" class="card">
      <label>Agent Name</label>
      <input id="agentName" />

      <div id="properties"></div>

      <button class="secondary" onclick="addProperty()">Add Another Property</button>
      <button onclick="submitRequests()">Request an Observer</button>
    </div>

    <div id="successScreen" class="card hidden">
      <strong>
        Your request is in the Observer Dashboard.<br>
        You will be notified once an observer accepts your request.
      </strong>
      <button class="secondary" onclick="startNewRequest()">Start New Request</button>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
        <div>
          <b>My Requests</b>
          <div class="muted">Accepted requests will show observer profile + contact link.</div>
        </div>
        <button class="secondary" onclick="renderMyRequests()">Refresh</button>
      </div>
      <div id="myList"></div>
    </div>
  </div>

<script>
  const REQUEST_KEY = "rg_agent_requests_v1";
  const STATUS_KEY  = "rg_request_status_v2"; // shared with observer rewrite above

  const MAX_PROPS = 3;

  const STATES = [
    "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA",
    "ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK",
    "OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"
  ];

  const TIMEZONES = ["Eastern","Central","Mountain","Pacific","Alaska","Hawaii"];

  let propertyCount = 0;

  function loadRequests(){ return JSON.parse(localStorage.getItem(REQUEST_KEY)) || []; }
  function saveRequests(v){ localStorage.setItem(REQUEST_KEY, JSON.stringify(v)); }

  function loadStatusMap(){ return JSON.parse(localStorage.getItem(STATUS_KEY)) || {}; }

  function esc(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function buildTimes(){
    // 6:00 AM to 9:30 PM in 30-min increments
    let out = "";
    for (let h = 6; h <= 21; h++) {
      ["00","30"].forEach(m => {
        const ampm = h >= 12 ? "PM" : "AM";
        const hr = h % 12 || 12;
        out += `<option>${hr}:${m} ${ampm}</option>`;
      });
    }
    return out;
  }

  function toggleOther(sel){
    const box = sel.closest(".propBlock").querySelector(".other");
    box.classList.toggle("hidden", sel.value !== "Other");
  }

  function propertyBlock(){
    return `
      <div class="propBlock">
        <hr>
        <label>Property Address</label>
        <input class="address">

        <label>City</label>
        <input class="city">

        <div class="row">
          <div>
            <label>US State</label>
            <select class="state">${STATES.map(s=>`<option>${s}</option>`).join("")}</select>
          </div>
          <div>
            <label>Zip Code</label>
            <input class="zip" inputmode="numeric" placeholder="Zip">
          </div>
        </div>

        <label>US Time Zone</label>
        <select class="timezone">${TIMEZONES.map(t=>`<option>${t}</option>`).join("")}</select>

        <label>Type of Visit</label>
        <select class="visit" onchange="toggleOther(this)">
          <option>Property Showing</option>
          <option>Open House</option>
          <option>Other</option>
        </select>

        <div class="other hidden">
          <label>Description</label>
          <textarea rows="3"></textarea>
        </div>

        <div class="row">
          <div>
            <label>Date</label>
            <input type="date" class="date">
          </div>
          <div>
            <label>Time</label>
            <select class="time">${buildTimes()}</select>
          </div>
        </div>

        <label>Duration</label>
        <select class="duration">
          <option>30 minutes</option>
          <option>1 hour</option>
          <option>1.5 hours</option>
          <option>2 hours</option>
          <option>2.5 hours</option>
          <option>3 hours</option>
        </select>
      </div>
    `;
  }

  function addProperty(){
    const wrap = document.getElementById("properties");
    if (wrap.children.length >= MAX_PROPS) return;
    const div = document.createElement("div");
    div.innerHTML = propertyBlock();
    wrap.appendChild(div);
    propertyCount++;
  }

  function twelveTo24(twelve){
    const parts = (twelve||"").trim().split(" ");
    if (parts.length !== 2) return "";
    const [hStr, mStr] = parts[0].split(":");
    let h = parseInt(hStr,10);
    const m = parseInt(mStr,10);
    if (Number.isNaN(h)||Number.isNaN(m)) return "";
    const ampm = parts[1].toUpperCase();
    if (ampm === "AM") { if (h === 12) h = 0; }
    else { if (h !== 12) h += 12; }
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  function scheduledDate(req){
    if (!req?.date || !req?.time) return null;
    const dt = new Date(`${req.date}T${req.time}`);
    if (Number.isNaN(dt.getTime())) return null;
    return dt;
  }

  function effectiveStatus(req, statusMap){
    const s = statusMap[req.id]?.status;
    if (s) return s;
    const dt = scheduledDate(req);
    if (dt && Date.now() > dt.getTime()) return "expired";
    return "pending";
  }

  function submitRequests(){
    const agent = document.getElementById("agentName").value.trim();
    if (!agent) return alert("Agent name required.");

    const blocks = document.querySelectorAll("#properties > div .propBlock");
    if (!blocks.length) return alert("Add at least one property.");

    const reqs = loadRequests();
    let createdAny = false;

    blocks.forEach((b, i) => {
      const address = b.querySelector(".address").value.trim();
      const city = b.querySelector(".city").value.trim();
      const state = b.querySelector(".state").value;
      const zip = b.querySelector(".zip").value.trim();
      const tz = b.querySelector(".timezone").value;
      const visit = b.querySelector(".visit").value;
      const desc = (visit === "Other") ? b.querySelector("textarea").value.trim() : "";
      const date = b.querySelector(".date").value;
      const time12 = b.querySelector(".time").value;
      const time24 = twelveTo24(time12);
      const duration = b.querySelector(".duration").value;

      if (!address || !city || !date || !time24) return;

      reqs.push({
        id: "req_" + Date.now() + "_" + i,
        agentName: agent,
        visitType: visit,
        description: desc,
        timeZone: tz,
        duration: duration,
        date: date,
        time: time24,        // for logic
        displayTime: time12,  // for UI
        address: `${address}, ${city}, ${state} ${zip}`.trim()
      });

      createdAny = true;
    });

    if (!createdAny) {
      alert("Please complete at least one property with date/time.");
      return;
    }

    saveRequests(reqs);

    document.getElementById("formScreen").classList.add("hidden");
    document.getElementById("successScreen").classList.remove("hidden");
    renderMyRequests();
  }

  function startNewRequest(){
    document.getElementById("successScreen").classList.add("hidden");
    document.getElementById("formScreen").classList.remove("hidden");

    document.getElementById("agentName").value = "";
    const wrap = document.getElementById("properties");
    wrap.innerHTML = "";
    propertyCount = 0;
    addProperty();
  }

  function cancelRequest(id){
    const statusMap = loadStatusMap();
    const st = statusMap[id]?.status;
    if (st === "accepted") return alert("This request is locked (accepted).");

    const reqs = loadRequests();
    const req = reqs.find(r => r.id === id);
    if (!req) return;

    const dt = scheduledDate(req);
    if (dt && Date.now() > dt.getTime()) return alert("This request is expired.");

    const filtered = reqs.filter(r => r.id !== id);
    saveRequests(filtered);
    renderMyRequests();
  }

  function renderMyRequests(){
    const list = document.getElementById("myList");
    const reqs = loadRequests().slice().reverse();
    const statusMap = loadStatusMap();

    list.innerHTML = "";
    if (reqs.length === 0) {
      list.innerHTML = `<div class="muted" style="margin-top:10px;">No requests yet.</div>`;
      return;
    }

    reqs.forEach(req => {
      const st = effectiveStatus(req, statusMap);
      let pill = `<span class="pill">PENDING</span>`;
      if (st === "accepted") pill = `<span class="pill pillGreen">ACCEPTED</span>`;
      if (st === "declined") pill = `<span class="pill pillRed">DECLINED</span>`;
      if (st === "expired") pill = `<span class="pill pillRed">EXPIRED</span>`;

      const obs = statusMap[req.id]?.observer;
      const obsLine = (st === "accepted" && obs)
        ? `<div class="muted" style="margin-top:8px;">
             <b>Observer:</b> ${esc(obs.name)} • <a href="tel:${encodeURIComponent(obs.phone)}">${esc(obs.phone)}</a>
             ${obs.email ? ` • <a href="mailto:${encodeURIComponent(obs.email)}">${esc(obs.email)}</a>` : ""}
           </div>`
        : "";

      const canCancel = (st === "pending");

      const el = document.createElement("div");
      el.className = "req";
      el.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div><b>${esc(req.address || "")}</b></div>
          <div>${pill}</div>
        </div>
        <div class="muted"><b>Visit:</b> ${esc(req.visitType || "")}${req.description ? ` — ${esc(req.description)}` : ""}</div>
        <div class="muted"><b>Date/Time:</b> ${esc(req.date || "")} ${esc(req.displayTime || req.time || "")}</div>
        <div class="muted"><b>Duration:</b> ${esc(req.duration || "")}</div>
        <div class="muted"><b>Time Zone:</b> ${esc(req.timeZone || "")}</div>
        ${obsLine}
        ${canCancel ? `<button class="danger" onclick="cancelRequest('${esc(req.id)}')">Cancel Request</button>` : ""}
      `;
      list.appendChild(el);
    });
  }

  // init
  addProperty();
  renderMyRequests();
</script>
</body>
</html>
