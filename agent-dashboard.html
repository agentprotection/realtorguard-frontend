<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Dashboard | Realtor Guard</title>

  <style>
    :root{
      --navy:#0B2C4F;
      --white:#FFFFFF;
      --border:#E5E7EB;
      --success:#16A34A;
      --danger:#B91C1C;
    }

    body{ margin:0; font-family:Arial,sans-serif; background:var(--white); color:var(--navy); }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid var(--border); background:var(--white);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; cursor:pointer; }
    .brand img{ width:28px; height:28px; object-fit:contain; }
    .actions button{
      background:var(--navy); color:var(--white); border:none; padding:8px 12px;
      border-radius:10px; font-size:14px; cursor:pointer;
    }

    .page{ max-width:900px; margin:0 auto; padding:24px; }
    h1{ text-align:center; margin:10px 0 6px; }
    .muted{ text-align:center; color:#666; margin:0 0 18px; }

    .card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      background:#fff;
      margin-top:14px;
    }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:760px){ .grid{ grid-template-columns:1fr; } }

    label{ font-size:13px; color:#444; display:block; margin-top:10px; }
    input, select, textarea{
      width:100%; box-sizing:border-box;
      padding:10px; margin-top:6px;
      border-radius:12px; border:1px solid var(--border);
      font-size:14px; background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      border:1px solid var(--border); font-size:12px; color:#555;
    }

    .btn{
      border:none; border-radius:12px; padding:12px 14px;
      font-size:15px; cursor:pointer;
    }
    .btn-primary{ background:var(--navy); color:var(--white); width:100%; }
    .btn-outline{
      background:#fff; color:var(--navy); border:1px solid var(--navy);
    }
    .btn-danger{ background:var(--danger); color:var(--white); }
    .btn-success{ background:var(--success); color:var(--white); }

    .small{ font-size:12px; color:#666; margin-top:10px; }

    .propHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:6px;
    }

    .profile{
      display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;
      margin-top:12px;
    }
    .avatar{
      width:72px; height:72px; border-radius:50%;
      background:#e5e7eb; display:flex; align-items:center; justify-content:center;
      font-weight:800; color:#555; font-size:22px;
      overflow:hidden;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .kv .label{ margin-top:8px; }
    .kv .value{ font-weight:800; margin-top:2px; }

    .empty{
      border:1px dashed var(--border);
      border-radius:14px;
      padding:18px;
      text-align:center;
      color:#666;
      margin-top:14px;
    }
  </style>
</head>

<body>
  <div class="nav">
    <div class="brand" onclick="goHome()">
      <img src="logo.png" alt="Realtor Guard" onerror="this.style.display='none'">
      <span>Realtor Guard</span>
    </div>
    <div class="actions">
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="page">
    <h1>Agent Dashboard</h1>
    <p class="muted">Request an observer and track your assignment</p>

    <div id="content"></div>

    <div class="small">
      MVP testing note: Agent + Observer must be tested in the <b>same device + same browser window</b> (localStorage).
    </div>
  </div>

<script>
  const MAX_PROPERTIES = 3;

  const STATES = [
    { code:"AL", name:"Alabama" }, { code:"AK", name:"Alaska" }, { code:"AZ", name:"Arizona" },
    { code:"AR", name:"Arkansas" }, { code:"CA", name:"California" }, { code:"CO", name:"Colorado" },
    { code:"CT", name:"Connecticut" }, { code:"DE", name:"Delaware" }, { code:"FL", name:"Florida" },
    { code:"GA", name:"Georgia" }, { code:"HI", name:"Hawaii" }, { code:"ID", name:"Idaho" },
    { code:"IL", name:"Illinois" }, { code:"IN", name:"Indiana" }, { code:"IA", name:"Iowa" },
    { code:"KS", name:"Kansas" }, { code:"KY", name:"Kentucky" }, { code:"LA", name:"Louisiana" },
    { code:"ME", name:"Maine" }, { code:"MD", name:"Maryland" }, { code:"MA", name:"Massachusetts" },
    { code:"MI", name:"Michigan" }, { code:"MN", name:"Minnesota" }, { code:"MS", name:"Mississippi" },
    { code:"MO", name:"Missouri" }, { code:"MT", name:"Montana" }, { code:"NE", name:"Nebraska" },
    { code:"NV", name:"Nevada" }, { code:"NH", name:"New Hampshire" }, { code:"NJ", name:"New Jersey" },
    { code:"NM", name:"New Mexico" }, { code:"NY", name:"New York" }, { code:"NC", name:"North Carolina" },
    { code:"ND", name:"North Dakota" }, { code:"OH", name:"Ohio" }, { code:"OK", name:"Oklahoma" },
    { code:"OR", name:"Oregon" }, { code:"PA", name:"Pennsylvania" }, { code:"RI", name:"Rhode Island" },
    { code:"SC", name:"South Carolina" }, { code:"SD", name:"South Dakota" }, { code:"TN", name:"Tennessee" },
    { code:"TX", name:"Texas" }, { code:"UT", name:"Utah" }, { code:"VT", name:"Vermont" },
    { code:"VA", name:"Virginia" }, { code:"WA", name:"Washington" }, { code:"WV", name:"West Virginia" },
    { code:"WI", name:"Wisconsin" }, { code:"WY", name:"Wyoming" }
  ];

  let propertyCount = 1;

  function goHome(){ window.location.href = "choose-role.html"; }
  function logout(){ localStorage.clear(); window.location.href = "index.html"; }

  function stateOptions(){
    return `<option value="">Select state...</option>` +
      STATES.map(s => `<option value="${s.code}">${s.name} (${s.code})</option>`).join("");
  }

  function hoursOptions(){
    let out = "";
    for(let h=1; h<=12; h++) out += `<option value="${h}">${h}</option>`;
    return out;
  }

  function minutesOptions(){
    // 00,05,10...55
    let out = "";
    for(let m=0; m<60; m+=5){
      const mm = String(m).padStart(2,"0");
      out += `<option value="${mm}">${mm}</option>`;
    }
    return out;
  }

  function render(){
    const content = document.getElementById("content");
    const req = JSON.parse(localStorage.getItem("assignmentRequest"));

    if(!req){
      content.innerHTML = requestFormHTML();
      renderProperties();
      updateCountPill();
      return;
    }

    if(req.status === "pending"){
      content.innerHTML = `
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div><b>Status:</b> Waiting for observer acceptance</div>
            <span class="pill">PENDING</span>
          </div>
          <div class="small">If you want to start over, use “Cancel Request”.</div>
          <div class="row" style="margin-top:12px;">
            <button class="btn btn-danger" onclick="cancelRequest()">Cancel Request</button>
          </div>
        </div>
      `;
      return;
    }

    if(req.status === "accepted"){
      const o = req.observer;
      // If observer missing (shouldn't happen), show safe fallback
      const observer = o || {
        fullName: "Observer",
        phone: "5551234567",
        vehicle: { make:"", model:"", year:"", color:"" },
        rating: "N/A",
        reviewsCount: 0,
        photoUrl: ""
      };

      content.innerHTML = `
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div><b>Status:</b> Observer Assigned</div>
            <span class="pill">ACCEPTED</span>
          </div>

          <div class="profile">
            <div class="avatar" id="avatarBox"></div>

            <div class="kv">
              <div class="label">Observer Name</div>
              <div class="value">${escapeHTML(observer.fullName || "")}</div>

              <div class="label">Vehicle</div>
              <div class="value">
                ${escapeHTML(formatVehicle(observer.vehicle))}
              </div>

              <div class="label">Observer Reviews</div>
              <div class="value">
                ${escapeHTML(observer.rating || "N/A")}
                ${observer.reviewsCount ? `(${observer.reviewsCount} reviews)` : ""}
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn btn-success" onclick="messageObserver('${escapeAttr(observer.phone || '')}')">
              Text Observer (Running Late)
            </button>
            <button class="btn btn-danger" onclick="cancelAssignment()">
              Cancel Assignment
            </button>
          </div>
        </div>
      `;

      renderAvatar(observer);
      return;
    }

    // Unknown status
    content.innerHTML = `<div class="empty">Unknown status. Clear storage and try again.</div>`;
  }

  function requestFormHTML(){
    return `
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div><b>Request an Observer</b></div>
          <span class="pill" id="countPill">Properties: 1 / 3</span>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div>
            <label>Agent Full Name</label>
            <input id="agentName" placeholder="Enter your full name" />
          </div>
          <div>
            <label>US Time Zone</label>
            <select id="timeZone">
              <option value="">Select time zone...</option>
              <option value="Eastern">Eastern (ET)</option>
              <option value="Central">Central (CT)</option>
              <option value="Mountain">Mountain (MT)</option>
              <option value="Pacific">Pacific (PT)</option>
              <option value="Alaska">Alaska (AKT)</option>
              <option value="Hawaii">Hawaii (HST)</option>
            </select>
          </div>
        </div>

        <div id="propertiesWrap"></div>

        <div class="row" style="justify-content:space-between; margin-top:12px;">
          <button class="btn btn-outline" type="button" onclick="addProperty()">+ Add Property</button>
          <button class="btn btn-danger" type="button" onclick="clearForm()">Clear</button>
        </div>

        <button class="btn btn-primary" type="button" onclick="submitRequest()">Submit Request</button>

        <div class="small">
          You can add up to 3 properties. Times use <b>12-hour AM/PM</b> (no military time).
        </div>
      </div>
    `;
  }

  function propertyHTML(i){
    return `
      <div class="card" data-prop="${i}">
        <div class="propHeader">
          <div><b>Property ${i+1}</b></div>
          ${i>0 ? `<button class="btn btn-danger" type="button" onclick="removeProperty(${i})">Delete Property</button>` : ``}
        </div>

        <div class="grid">
          <div>
            <label>Street Address</label>
            <input id="street_${i}" placeholder="123 Main St" />
          </div>
          <div>
            <label>City</label>
            <input id="city_${i}" placeholder="City" />
          </div>

          <div>
            <label>State</label>
            <select id="state_${i}">
              ${stateOptions()}
            </select>
          </div>
          <div>
            <label>Zip Code</label>
            <input id="zip_${i}" placeholder="Zip" />
          </div>

          <div>
            <label>Date</label>
            <input type="date" id="date_${i}" />
          </div>

          <div>
            <label>Time (AM/PM)</label>
            <div class="row">
              <select id="hour_${i}" style="flex:1;">${hoursOptions()}</select>
              <select id="min_${i}" style="flex:1;">${minutesOptions()}</select>
              <select id="ampm_${i}" style="flex:1;">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
          </div>

          <div>
            <label>Type of Visit</label>
            <select id="visit_${i}" onchange="toggleOther(${i})">
              <option value="">Select type...</option>
              <option value="Showing">Showing</option>
              <option value="Open House">Open House</option>
              <option value="Other">Other</option>
            </select>

            <div id="otherWrap_${i}" style="display:none; margin-top:10px;">
              <label>Other Description</label>
              <textarea id="otherDesc_${i}" placeholder="Describe the visit type..."></textarea>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderProperties(){
    const wrap = document.getElementById("propertiesWrap");
    wrap.innerHTML = "";
    for(let i=0;i<propertyCount;i++){
      wrap.innerHTML += propertyHTML(i);
    }
  }

  function updateCountPill(){
    const pill = document.getElementById("countPill");
    if(pill) pill.textContent = `Properties: ${propertyCount} / 3`;
  }

  function addProperty(){
    if(propertyCount >= MAX_PROPERTIES){
      alert("Maximum 3 properties per request.");
      return;
    }
    const current = collectPropertiesSafe();
    propertyCount++;
    renderProperties();
    updateCountPill();
    rehydrateProperties(current);
  }

  function removeProperty(index){
    const current = collectPropertiesSafe().filter((_,i)=>i!==index);
    propertyCount = Math.max(1, current.length);
    renderProperties();
    updateCountPill();
    rehydrateProperties(current);
  }

  function toggleOther(i){
    const type = document.getElementById(`visit_${i}`).value;
    document.getElementById(`otherWrap_${i}`).style.display = (type === "Other") ? "block" : "none";
  }

  function getTime12(i){
    const h = document.getElementById(`hour_${i}`).value;
    const m = document.getElementById(`min_${i}`).value;
    const ap = document.getElementById(`ampm_${i}`).value;
    return `${h}:${m} ${ap}`;
  }

  function collectPropertiesSafe(){
    const props = [];
    for(let i=0;i<propertyCount;i++){
      props.push({
        street: (document.getElementById(`street_${i}`)?.value || "").trim(),
        city: (document.getElementById(`city_${i}`)?.value || "").trim(),
        state: (document.getElementById(`state_${i}`)?.value || ""),
        zip: (document.getElementById(`zip_${i}`)?.value || "").trim(),
        date: (document.getElementById(`date_${i}`)?.value || ""),
        time: getTime12(i),
        visitType: (document.getElementById(`visit_${i}`)?.value || ""),
        otherDesc: (document.getElementById(`otherDesc_${i}`)?.value || "").trim()
      });
    }
    return props;
  }

  function rehydrateProperties(props){
    props.forEach((p,i)=>{
      if(!document.getElementById(`street_${i}`)) return;

      document.getElementById(`street_${i}`).value = p.street || "";
      document.getElementById(`city_${i}`).value = p.city || "";
      document.getElementById(`state_${i}`).value = p.state || "";
      document.getElementById(`zip_${i}`).value = p.zip || "";
      document.getElementById(`date_${i}`).value = p.date || "";

      // time parse "h:mm AM"
      const t = (p.time || "").trim();
      const m = t.match(/^(\d{1,2}):(\d{2})\s(AM|PM)$/i);
      if(m){
        document.getElementById(`hour_${i}`).value = String(parseInt(m[1],10));
        document.getElementById(`min_${i}`).value = m[2];
        document.getElementById(`ampm_${i}`).value = m[3].toUpperCase();
      }

      document.getElementById(`visit_${i}`).value = p.visitType || "";
      toggleOther(i);
      document.getElementById(`otherDesc_${i}`).value = p.otherDesc || "";
    });
  }

  function clearForm(){
    if(!confirm("Clear the form?")) return;
    document.getElementById("agentName").value = "";
    document.getElementById("timeZone").value = "";
    propertyCount = 1;
    renderProperties();
    updateCountPill();
  }

  function validate(){
    const agentName = (document.getElementById("agentName").value || "").trim();
    const tz = document.getElementById("timeZone").value;

    if(!agentName){ alert("Agent full name is required."); return false; }
    if(!tz){ alert("US time zone is required."); return false; }

    const props = collectPropertiesSafe();
    for(let i=0;i<props.length;i++){
      const p = props[i];
      const pre = `Property ${i+1}: `;
      if(!p.street){ alert(pre+"Street address is required."); return false; }
      if(!p.city){ alert(pre+"City is required."); return false; }
      if(!p.state){ alert(pre+"State is required."); return false; }
      if(!p.zip){ alert(pre+"Zip code is required."); return false; }
      if(!p.date){ alert(pre+"Date is required."); return false; }
      if(!p.visitType){ alert(pre+"Visit type is required."); return false; }
      if(p.visitType === "Other" && !p.otherDesc){ alert(pre+"Please add a description for Other."); return false; }
    }
    return true;
  }

  function submitRequest(){
    if(!validate()) return;

    const request = {
      agentName: document.getElementById("agentName").value.trim(),
      timeZone: document.getElementById("timeZone").value,
      status: "pending",
      createdAt: new Date().toISOString(),
      properties: collectPropertiesSafe()
    };

    localStorage.setItem("assignmentRequest", JSON.stringify(request));
    localStorage.setItem("role","agent");
    render();
  }

  function cancelRequest(){
    if(!confirm("Cancel this request?")) return;
    localStorage.removeItem("assignmentRequest");
    localStorage.removeItem("activePropertyIndex");
    render();
  }

  function cancelAssignment(){
    if(!confirm("Cancel this assignment?")) return;
    localStorage.removeItem("assignmentRequest");
    localStorage.removeItem("activePropertyIndex");
    render();
  }

  function messageObserver(phone){
    const msg = encodeURIComponent("Hi, I’m running a few minutes late. Thank you for waiting.");
    const isMobile = /iPhone|Android/i.test(navigator.userAgent);
    const url = isMobile
      ? `sms:${phone}?&body=${msg}`
      : `mailto:?subject=Realtor Guard Update&body=${msg}`;
    window.location.href = url;
  }

  function formatVehicle(v){
    if(!v) return "—";
    const parts = [v.make, v.model, v.year, v.color].filter(Boolean);
    return parts.length ? parts.join(" • ") : "—";
  }

  function renderAvatar(observer){
    const box = document.getElementById("avatarBox");
    if(!box) return;

    const initials = (observer.fullName || "")
      .split(" ")
      .filter(Boolean)
      .slice(0,2)
      .map(s=>s[0].toUpperCase())
      .join("") || "RG";

    if(observer.photoUrl){
      box.innerHTML = `<img src="${escapeAttr(observer.photoUrl)}" alt="Observer"/>`;
    } else {
      box.textContent = initials;
    }
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function escapeAttr(s){ return escapeHTML(s).replace(/"/g,"&quot;"); }

  // init
  render();
</script>
</body>
</html>
