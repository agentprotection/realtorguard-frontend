<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-top:14px;
box-shadow:0 2px 8px rgba(0,0,0,.08)}
input,select,button,textarea{
  width:100%;padding:14px;margin-top:10px;
  border-radius:12px;font-size:16px;box-sizing:border-box
}
button{border:none;font-weight:900;background:#111;color:#fff}
.secondary{background:#fff;color:#111;border:1px solid #ccc}
.status{margin-top:8px;font-weight:900}
.pending{color:#6b7280}
.accepted{color:#2563eb}
.inroute{color:#16a34a}
.expired{color:#dc2626}
</style>
</head>

<body>
<div class="wrap">
<h2>Agent Dashboard</h2>

<!-- FORM -->
<div class="card">
  <input id="agentName" placeholder="Agent Name">

  <!-- PROPERTIES -->
  <div id="properties"></div>

  <!-- US TIME ZONES ONLY -->
  <select id="timezone">
    <option value="">Time Zone</option>
    <option>Eastern</option>
    <option>Central</option>
    <option>Mountain</option>
    <option>Pacific</option>
  </select>

  <!-- VISIT TYPE -->
  <select id="visitType" onchange="toggleOther()">
    <option value="">Visit Type</option>
    <option>Open House</option>
    <option>Showing</option>
    <option>Other</option>
  </select>

  <textarea id="otherDesc" placeholder="Description" style="display:none"></textarea>

  <!-- DATE / TIME -->
  <input id="date" type="date" aria-label="Date">
  <input id="time" type="time" aria-label="Time">

  <!-- DURATION -->
  <select id="duration">
    <option value="">Duration</option>
    <option>30 minutes</option>
    <option>60 minutes</option>
    <option>90 minutes</option>
    <option>120 minutes</option>
    <option>150 minutes</option>
    <option>180 minutes</option>
    <option>210 minutes</option>
    <option>240 minutes</option>
  </select>

  <!-- ADD PROPERTY AFTER DURATION -->
  <button class="secondary" onclick="addProperty()">Add Property</button>

  <button onclick="submitRequest()">Request Observer</button>
</div>

<!-- CONTROLS -->
<div class="card">
  <button class="secondary" onclick="deleteExpired()">Delete Expired Requests</button>
  <button class="secondary" onclick="render()">Refresh</button>
</div>

<!-- REQUEST LIST -->
<div class="card">
  <div id="list"></div>
</div>

</div>

<script>
const REQ_KEY = "rg_agent_requests_v1";
const STATUS_KEY = "rg_request_status_v3";

const loadReq = () => JSON.parse(localStorage.getItem(REQ_KEY)) || [];
const saveReq = r => localStorage.setItem(REQ_KEY, JSON.stringify(r));
const loadStatus = () => JSON.parse(localStorage.getItem(STATUS_KEY)) || {};
const saveStatus = s => localStorage.setItem(STATUS_KEY, JSON.stringify(s));

const propertiesDiv = document.getElementById("properties");
const list = document.getElementById("list");
const otherDesc = document.getElementById("otherDesc");

let propCount = 0;

/* ---------- PROPERTY BLOCK ---------- */
function propertyBlock(){
  return `
    <input class="propAddress" placeholder="Property Address">
    <input class="propCity" placeholder="City">
    <input class="propZip" placeholder="ZIP Code">
    <select class="propState">
      <option value="">State</option>
      ${["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"]
        .map(s=>`<option>${s}</option>`).join("")}
    </select>
  `;
}

function addProperty(){
  if(propCount >= 3) return;
  propCount++;
  const d = document.createElement("div");
  d.className = "card";
  d.innerHTML = propertyBlock();
  propertiesDiv.appendChild(d);
}

/* create first property by default */
addProperty();

/* ---------- VISIT TYPE ---------- */
function toggleOther(){
  otherDesc.style.display =
    document.getElementById("visitType").value === "Other"
      ? "block" : "none";
}

/* ---------- SUBMIT ---------- */
function submitRequest(){
  const agentName = document.getElementById("agentName").value.trim();
  const timezone = document.getElementById("timezone").value;
  const visitType = document.getElementById("visitType").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const duration = document.getElementById("duration").value;

  const addrs = [...document.querySelectorAll(".propAddress")].map(x=>x.value.trim());
  const cities = [...document.querySelectorAll(".propCity")].map(x=>x.value.trim());
  const zips = [...document.querySelectorAll(".propZip")].map(x=>x.value.trim());
  const states = [...document.querySelectorAll(".propState")].map(x=>x.value);

  if(!agentName || !addrs[0] || !cities[0] || !states[0] || !zips[0] ||
     !timezone || !visitType || !date || !time || !duration){
    alert("Complete required fields");
    return;
  }

  const properties = [];
  for(let i=0;i<addrs.length;i++){
    if(addrs[i]){
      if(!cities[i] || !states[i] || !zips[i]){
        alert("Complete required fields");
        return;
      }
      properties.push({
        address:addrs[i],
        city:cities[i],
        state:states[i],
        zip:zips[i]
      });
    }
  }

  const reqs = loadReq();
  const id = Date.now().toString();

  reqs.push({
    id,
    agentName,
    properties,
    timezone,
    visitType,
    otherDesc: visitType==="Other" ? otherDesc.value : "",
    date,
    time,
    duration
  });

  saveReq(reqs);
  render();
}

/* ---------- STATUS ---------- */
function resolveStatus(r){
  const s = loadStatus()[r.id];
  const now = Date.now();
  const sched = new Date(`${r.date}T${r.time}`).getTime();

  if(s?.status==="in_route") return {t:"In Route",c:"inroute"};
  if(s?.status==="accepted") return {t:"Accepted",c:"accepted"};
  if(now> sched) return {t:"Expired",c:"expired"};
  return {t:"Pending",c:"pending"};
}

/* ---------- DELETE / CANCEL ---------- */
function cancelRequest(id){
  saveReq(loadReq().filter(r=>r.id!==id));
  const st = loadStatus();
  st[id] = {status:"canceled_by_agent",time:Date.now()};
  saveStatus(st);
  render();
}

function deleteRequest(id){
  saveReq(loadReq().filter(r=>r.id!==id));
  const st = loadStatus();
  delete st[id];
  saveStatus(st);
  render();
}

function deleteExpired(){
  const now = Date.now();
  const st = loadStatus();
  saveReq(loadReq().filter(r=>{
    if(st[r.id]?.status==="accepted") return true;
    if(st[r.id]?.status==="in_route") return true;
    return new Date(`${r.date}T${r.time}`).getTime() > now;
  }));
  render();
}

/* ---------- RENDER ---------- */
function render(){
  list.innerHTML="";
  loadReq().forEach(r=>{
    const s = resolveStatus(r);
    const first = r.properties[0];
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <b>${first.address}, ${first.city}, ${first.state} ${first.zip}</b>
      <div>${r.date} ${r.time}</div>
      <div class="status ${s.c}">${s.t}</div>
      <button class="secondary" onclick="cancelRequest('${r.id}')">Cancel</button>
      ${s.t==="Expired"
        ? `<button class="secondary" onclick="deleteRequest('${r.id}')">Delete</button>`
        : ``}
    `;
    list.appendChild(card);
  });
}

setInterval(render,1000);
render();
</script>
</body>
</html>
