<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f4f4f4;
}
.wrap{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:12px;
  font-size:16px;
}
button{
  border:none;
  font-weight:900;
  background:#111;
  color:#fff;
}
.status{
  margin-top:8px;
  font-weight:900;
}
.accepted{
  color:#2563eb; /* blue */
}
.inroute{
  color:#16a34a; /* green */
}
.pending{
  color:#6b7280; /* grey */
}
.expired{
  color:#dc2626; /* red */
}
</style>
</head>

<body>
<div class="wrap">
<h2>Agent Dashboard</h2>

<!-- AGENT REQUEST FORM (UNCHANGED FORMAT) -->
<div class="card">
  <input id="agentName" placeholder="Agent Name">
  <input id="address" placeholder="Property Address">
  <input id="city" placeholder="City">
  <select id="state">
    <option value="">State</option>
    <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
    <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
    <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
    <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
    <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
    <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
    <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
    <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
    <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
    <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
    <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
    <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
    <option>WI</option><option>WY</option>
  </select>
  <input id="date" type="date">
  <input id="time" type="time">
  <button onclick="submitRequest()">Request Observer</button>
</div>

<!-- REQUEST LIST -->
<div class="card">
  <div id="list"></div>
</div>

</div>

<script>
/* ===== STORAGE KEYS ===== */
const REQ_KEY = "rg_agent_requests_v1";
const STATUS_KEY = "rg_request_status_v3";

/* ===== HELPERS ===== */
const loadReq = () =>
  JSON.parse(localStorage.getItem(REQ_KEY)) || [];

const saveReq = r =>
  localStorage.setItem(REQ_KEY, JSON.stringify(r));

const loadStatus = () =>
  JSON.parse(localStorage.getItem(STATUS_KEY)) || {};

function scheduledAt(r){
  return new Date(`${r.date}T${r.time}`);
}

/* ===== SUBMIT REQUEST ===== */
function submitRequest(){
  if(!address.value || !date.value || !time.value){
    alert("Complete the form");
    return;
  }

  const reqs = loadReq();
  reqs.push({
    id: Date.now().toString(),
    agentName: agentName.value,
    address: `${address.value}, ${city.value}, ${state.value}`,
    date: date.value,
    time: time.value
  });

  saveReq(reqs);
  render();
}

/* ===== STATUS MAPPING (THE KEY FIX) ===== */
function getAgentStatus(req){
  const statusMap = loadStatus();
  const stat = statusMap[req.id];
  const sched = scheduledAt(req);

  if(stat?.status === "in_route"){
    return { text: "In Route", cls: "inroute" };
  }

  if(stat?.status === "accepted"){
    return { text: "Accepted", cls: "accepted" };
  }

  if(Date.now() > sched.getTime()){
    return { text: "Expired", cls: "expired" };
  }

  return { text: "Pending", cls: "pending" };
}

/* ===== RENDER ===== */
function render(){
  list.innerHTML = "";
  const reqs = loadReq();

  reqs.forEach(r=>{
    const card = document.createElement("div");
    card.className = "card";

    const status = getAgentStatus(r);

    card.innerHTML = `
      <b>${r.address}</b>
      <div>${r.date} ${r.time}</div>
      <div class="status ${status.cls}">${status.text}</div>
    `;

    list.appendChild(card);
  });
}

render();
</script>
</body>
</html>
