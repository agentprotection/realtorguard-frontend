<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Observer Dashboard | Realtor Guard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }

    .container {
      max-width: 900px;
      margin: auto;
    }

    h1 {
      margin-bottom: 14px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .row {
      margin-bottom: 6px;
      font-size: 14px;
    }

    .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 12px;
    }

    .pending { background: #eee; }
    .accepted { background: #d4f8d4; }
    .declined { background: #ffdede; }

    .countdown {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .accept { background: #111; color: #fff; }
    .decline { background: #b00020; color: #fff; }
    .start { background: #0066ff; color: #fff; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Observer Dashboard</h1>
    <div id="list"></div>
  </div>

  <script>
    const REQUESTS_KEY = "rg_agent_requests_v1";
    const STATUS_KEY = "rg_observer_status_v1";

    const requests =
      JSON.parse(localStorage.getItem(REQUESTS_KEY)) || [];
    const statusMap =
      JSON.parse(localStorage.getItem(STATUS_KEY)) || {};

    function saveStatus() {
      localStorage.setItem(STATUS_KEY, JSON.stringify(statusMap));
    }

    function countdown(date, time) {
      const target = new Date(`${date}T${time}`);
      const diff = target - new Date();
      if (diff <= 0) return "00:00:00";

      const h = String(Math.floor(diff / 3600000)).padStart(2,"0");
      const m = String(Math.floor((diff % 3600000)/60000)).padStart(2,"0");
      const s = String(Math.floor((diff % 60000)/1000)).padStart(2,"0");
      return `${h}:${m}:${s}`;
    }

    function maps(addr) {
      window.open(
        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`,
        "_blank"
      );
    }

    function render() {
      const list = document.getElementById("list");
      list.innerHTML = "";

      requests.forEach(r => {
        const status = statusMap[r.id] || "pending";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="row"><b>Agent:</b> ${r.agentName}</div>
          <div class="row"><b>Visit:</b> ${r.visitType}</div>
          <div class="row"><b>Address:</b> ${r.address}</div>
          <div class="row"><b>Date:</b> ${r.date}</div>
          <div class="row"><b>Time:</b> ${r.time}</div>
          <span class="status ${status}">${status.toUpperCase()}</span>
          <div class="countdown" id="cd-${r.id}"></div>
        `;

        const actions = document.createElement("div");
        actions.className = "actions";

        if (status === "pending") {
          actions.innerHTML = `
            <button class="accept">Accept</button>
            <button class="decline">Decline</button>
          `;
          actions.children[0].onclick = () => {
            statusMap[r.id] = "accepted";
            saveStatus(); render();
          };
          actions.children[1].onclick = () => {
            statusMap[r.id] = "declined";
            saveStatus(); render();
          };
        }

        if (status === "accepted") {
          const btn = document.createElement("button");
          btn.className = "start";
          btn.innerText = "Start Assignment (Maps)";
          btn.onclick = () => maps(r.address);
          actions.appendChild(btn);
        }

        card.appendChild(actions);
        list.appendChild(card);
      });
    }

    function tick() {
      requests.forEach(r => {
        const el = document.getElementById(`cd-${r.id}`);
        if (el) el.innerText = "Countdown: " + countdown(r.date, r.time);
      });
    }

    render();
    tick();
    setInterval(tick, 1000);
  </script>
</body>
</html>
