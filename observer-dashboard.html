<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Observer Dashboard | Realtor Guard</title>

<style>
:root{
  --navy:#0B2C4F;
  --border:#E5E7EB;
  --success:#16A34A;
  --danger:#B91C1C;
  --muted:#6B7280;
}
body{margin:0;font-family:Arial,sans-serif;color:var(--navy);}
.nav{padding:14px 18px;border-bottom:1px solid var(--border);font-weight:700;}
.page{max-width:980px;margin:auto;padding:24px;}
.card{border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px;}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.btn{padding:12px 14px;border:none;border-radius:10px;font-size:15px;cursor:pointer;}
.success{background:var(--success);color:white;}
.danger{background:var(--danger);color:white;}
.outline{background:white;border:1px solid var(--navy);color:var(--navy);}
.badge{padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;}
.small{font-size:12px;color:var(--muted);}
.disabled{opacity:.5;pointer-events:none;}
</style>
</head>

<body>

<div class="nav">üõ°Ô∏è Realtor Guard ‚Äî Observer Dashboard</div>

<div class="page">
  <h2>Available Property Assignments</h2>
  <div id="content"></div>
</div>

<script>
const OBSERVER_ID = "observer-001"; // MVP mock observer

function render(){
  const c = document.getElementById("content");
  const req = JSON.parse(localStorage.getItem("assignmentRequest"));

  if(!req){
    c.innerHTML = `<div class="card">No assignments available.</div>`;
    return;
  }

  const properties = req.properties || [];
  const cards = properties
    .map((p,i)=>propertyCard(req,p,i))
    .filter(Boolean)
    .join("");

  c.innerHTML = cards || `<div class="card">No assignments available.</div>`;
}

function propertyCard(req,p,i){
  p.declinedBy = p.declinedBy || [];

  if(p.status === "canceled") return null;
  if(p.declinedBy.includes(OBSERVER_ID)) return null;

  if(p.status === "accepted" && p.observer?.id !== OBSERVER_ID) return null;

  const startTs = getStartTimestamp(req.timeZone, p.date, p.time);
  const now = Date.now();
  const canStart = now >= startTs;

  let timerHTML = "";
  if(p.status === "accepted" && !canStart){
    timerHTML = `<div class="small">Starts in: <span id="timer-${i}"></span></div>`;
    setTimeout(()=>startTimer(i,startTs),100);
  }

  return `
  <div class="card">
    <b>${p.street}, ${p.city}, ${p.state}</b>
    <div class="small">${p.date} @ ${p.time} (${req.timeZone})</div>

    <div class="row" style="margin-top:10px;">
      <span class="badge">${p.status.toUpperCase()}</span>
    </div>

    ${p.status==="open"?`
      <div class="row" style="margin-top:12px;">
        <button class="btn success" onclick="accept(${i})">Accept</button>
        <button class="btn danger" onclick="decline(${i})">Decline</button>
      </div>
    `:""}

    ${p.status==="accepted" && p.observer?.id===OBSERVER_ID?`
      ${timerHTML}
      <button class="btn outline ${canStart?"":"disabled"}"
        onclick="startAssignment(${i})">
        Start Assignment
      </button>
    `:""}
  </div>`;
}

function accept(i){
  const req = JSON.parse(localStorage.getItem("assignmentRequest"));
  const p = req.properties[i];

  p.status = "accepted";
  p.observer = {
    id: OBSERVER_ID,
    name: "Marcus Reed",
    phone: "5551234567"
  };

  localStorage.setItem("assignmentRequest",JSON.stringify(req));
  render();
}

function decline(i){
  const req = JSON.parse(localStorage.getItem("assignmentRequest"));
  const p = req.properties[i];

  p.status = "open";
  p.declinedBy = p.declinedBy || [];
  p.declinedBy.push(OBSERVER_ID);

  localStorage.setItem("assignmentRequest",JSON.stringify(req));
  render();
}

function startAssignment(i){
  const req = JSON.parse(localStorage.getItem("assignmentRequest"));
  const p = req.properties[i];

  p.status = "in_progress";
  localStorage.setItem("assignmentRequest",JSON.stringify(req));
  alert("Assignment started.");
  render();
}

function startTimer(i,target){
  const el = document.getElementById(`timer-${i}`);
  if(!el) return;

  const tick = ()=>{
    const diff = target - Date.now();
    if(diff<=0){
      el.textContent = "Ready";
      render();
      return;
    }
    const h = Math.floor(diff/3600000);
    const m = Math.floor((diff%3600000)/60000);
    const s = Math.floor((diff%60000)/1000);
    el.textContent = `${h}h ${m}m ${s}s`;
    requestAnimationFrame(tick);
  };
  tick();
}

function getStartTimestamp(tz,date,time){
  const map = {
    Eastern:-5, Central:-6, Mountain:-7,
    Pacific:-8, Alaska:-9, Hawaii:-10
  };
  const [hour,min,ampm] = time.match(/(\d+):(\d+)\s(AM|PM)/).slice(1);
  let h = parseInt(hour,10)%12 + (ampm==="PM"?12:0);
  const utc = new Date(`${date}T${String(h).padStart(2,"0")}:${min}:00Z`);
  utc.setHours(utc.getHours() - map[tz]);
  return utc.getTime();
}

render();
</script>
</body>
</html>
