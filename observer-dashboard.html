/* ========= STORAGE KEYS (LOCKED) ========= */
const REQ = "rg_agent_requests_v1";
const STATUS = "rg_request_status_v3";
const OBS = "rg_observer_profile_v2";

/* ========= STATE ========= */
let photoReady = false;

/* ========= LOADERS ========= */
const loadReq = () => JSON.parse(localStorage.getItem(REQ)) || [];
const loadStatus = () => JSON.parse(localStorage.getItem(STATUS)) || {};
const saveStatus = s => localStorage.setItem(STATUS, JSON.stringify(s));

/* ========= DATE ========= */
function scheduledAt(req) {
  if (!req.date || !req.time) return null;
  return new Date(`${req.date}T${req.time}`);
}

/* ========= PHOTO ========= */
function photoLoad(e) {
  const file = e.target.files[0];
  if (!file) return;

  photoReady = false;

  const reader = new FileReader();
  reader.onload = () => {
    photo.src = reader.result;
    photoReady = true;
  };
  reader.readAsDataURL(file);
}

/* ========= PROFILE ========= */
function saveProfile() {
  if (!name.value || !phone.value || !photoReady) {
    alert("Please upload a photo and wait for it to finish loading.");
    return;
  }

  localStorage.setItem(OBS, JSON.stringify({
    name: name.value.trim(),
    phone: phone.value.trim(),
    photo: photo.src
  }));

  alert("Profile saved");
}

/* ========= ACCEPT ========= */
function accept(id) {
  const profile = JSON.parse(localStorage.getItem(OBS));
  if (!profile) {
    alert("Please save your profile first.");
    return;
  }

  const map = loadStatus();
  map[id] = {
    status: "accepted",
    acceptedAt: Date.now(),
    observer: profile
  };

  saveStatus(map);
  render();
}

/* ========= RENDER ========= */
function render() {
  list.innerHTML = "";
  const reqs = loadReq();
  const statusMap = loadStatus();

  reqs.forEach(req => {
    const sched = scheduledAt(req);
    const stat = statusMap[req.id];
    let state = "pending";

    if (stat?.status === "accepted") {
      state = Date.now() >= sched ? "active" : "accepted";
    } else if (sched && Date.now() > sched) {
      state = "expired";
    }

    let countdown = "";
    if (state === "accepted" && sched) {
      const diff = sched - Date.now();
      const s = Math.max(0, Math.floor(diff / 1000));
      const h = String(Math.floor(s / 3600)).padStart(2, "0");
      const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
      const sec = String(s % 60).padStart(2, "0");
      countdown = `<div>Countdown: ${h}:${m}:${sec}</div>`;
    }

    list.innerHTML += `
      <div class="card">
        <b>${req.address || ""}</b>
        <div>${req.date} ${req.displayTime || req.time}</div>
        <div>${state.toUpperCase()}</div>
        ${countdown}
        ${state === "pending" ? `<button onclick="accept('${req.id}')">Accept</button>` : ""}
        <button class="${state === "active" ? "" : "disabled"}"
          onclick="window.open('https://maps.google.com?q=${encodeURIComponent(req.address)}')">
          Start Assignment
        </button>
      </div>
    `;
  });
}

/* ========= LIVE ========= */
setInterval(render, 1000);
render();
