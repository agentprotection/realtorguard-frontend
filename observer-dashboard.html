<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Observer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-top:14px;
box-shadow:0 2px 8px rgba(0,0,0,.08)}
button{width:100%;padding:14px;margin-top:10px;
border-radius:12px;font-size:16px;font-weight:900;border:none}
.accept{background:#111;color:#fff}
.cancel{background:#fff;color:#111;border:1px solid #ccc}
.disabled{opacity:.5;pointer-events:none}
</style>
</head>

<body>
<div class="wrap">
<h2>Observer Dashboard</h2>

<div class="card">
  <div id="list"></div>
</div>
</div>

<script>
/* ===== STORAGE KEYS ===== */
const REQ_KEY = "rg_agent_requests_v1";
const STATUS_KEY = "rg_request_status_v3";

/* ===== HELPERS ===== */
const loadReq = () => JSON.parse(localStorage.getItem(REQ_KEY)) || [];
const loadStatus = () => JSON.parse(localStorage.getItem(STATUS_KEY)) || {};
const saveStatus = s => localStorage.setItem(STATUS_KEY, JSON.stringify(s));

function scheduledAt(r){
  if(!r.date || !r.time) return null;
  return new Date(`${r.date}T${r.time}`);
}

/* ===== ACTIONS ===== */
function accept(id){
  const status = loadStatus();
  status[id] = {
    status: "accepted",
    acceptedAt: Date.now()
  };
  saveStatus(status);
  render();
}

function cancel(id){
  const status = loadStatus();
  delete status[id]; // release request
  saveStatus(status);
  render();
}

/* ===== RENDER ===== */
function render(){
  list.innerHTML = "";
  const reqs = loadReq();
  const status = loadStatus();
  const now = Date.now();

  reqs.forEach(r=>{
    const sched = scheduledAt(r);
    if(!sched || now > sched && !status[r.id]) return;

    let state = "open";
    if(status[r.id]?.status === "accepted"){
      state = now >= sched ? "active" : "accepted";
    }

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <b>${r.address}</b>
      <div>${r.date} ${r.time}</div>
      <div>${state.toUpperCase()}</div>
    `;

    // COUNTDOWN
    if(state === "accepted"){
      const diff = Math.max(0, sched - now);
      const s = Math.floor(diff/1000);
      const h = String(Math.floor(s/3600)).padStart(2,"0");
      const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const sec = String(s%60).padStart(2,"0");

      const cd = document.createElement("div");
      cd.innerText = `${h}:${m}:${sec}`;
      card.appendChild(cd);
    }

    // ACCEPT
    if(state === "open"){
      const b = document.createElement("button");
      b.className = "accept";
      b.innerText = "Accept";
      b.onclick = ()=>accept(r.id);
      card.appendChild(b);
    }

    // CANCEL
    if(state === "accepted"){
      const c = document.createElement("button");
      c.className = "cancel";
      c.innerText = "Cancel";
      c.onclick = ()=>cancel(r.id);
      card.appendChild(c);
    }

    // START
    const start = document.createElement("button");
    start.innerText = "Start Assignment";
    if(state !== "active") start.classList.add("disabled");
    start.onclick = ()=>window.open(
      `https://maps.google.com?q=${encodeURIComponent(r.address)}`
    );
    card.appendChild(start);

    list.appendChild(card);
  });
}

setInterval(render,1000);
render();
</script>
</body>
</html>
