<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Observer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f4f4f4; }
    .wrap { max-width:900px; margin:auto; padding:16px; }
    h1 { margin-bottom:10px; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); margin-top:14px; }
    label { display:block; font-weight:900; margin-top:12px; }
    input { width:100%; padding:12px; margin-top:6px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
    button { padding:12px; border:none; border-radius:12px; font-weight:900; cursor:pointer; }
    .btn { background:#111; color:#fff; width:100%; }
    .btn2 { background:#fff; border:1px solid #ccc; width:100%; }
    .disabled { opacity:.5; pointer-events:none; }
    .pill { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#eee; }
    .green { background:#e7ffe7; color:#145214; }
    .red { background:#ffecec; color:#7a0000; }
    img { max-width:80px; border-radius:50%; margin-top:8px; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Observer Dashboard</h1>

  <!-- OBSERVER PROFILE -->
  <div class="card">
    <label>Name</label>
    <input id="obsName">

    <label>Phone</label>
    <input id="obsPhone">

    <label>Upload Photo</label>
    <input type="file" accept="image/*" onchange="loadPhoto(event)">
    <img id="photoPreview">

    <button class="btn2" onclick="saveProfile()">Save Profile</button>
  </div>

  <!-- REQUEST LIST -->
  <div class="card">
    <h3>Incoming Requests</h3>
    <div id="list"></div>
  </div>
</div>

<script>
const REQ_KEY = "rg_agent_requests_v1";
const STATUS_KEY = "rg_request_status_v3";
const OBS_KEY = "rg_observer_profile_v2";

const loadReqs = () => JSON.parse(localStorage.getItem(REQ_KEY)) || [];
const loadStatus = () => JSON.parse(localStorage.getItem(STATUS_KEY)) || {};
const saveStatus = s => localStorage.setItem(STATUS_KEY, JSON.stringify(s));

function saveProfile(){
  const profile = {
    name: obsName.value.trim(),
    phone: obsPhone.value.trim(),
    photo: photoPreview.src || ""
  };
  if (!profile.name || !profile.phone) {
    alert("Name and phone required");
    return;
  }
  localStorage.setItem(OBS_KEY, JSON.stringify(profile));
  alert("Profile saved");
}

function loadPhoto(e){
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => photoPreview.src = reader.result;
  reader.readAsDataURL(file);
}

function scheduledAt(req){
  return req.date && req.time ? new Date(`${req.date}T${req.time}`) : null;
}

function getState(req, status){
  if (status?.status === "accepted") {
    if (Date.now() >= scheduledAt(req)) return "active";
    return "accepted";
  }
  if (scheduledAt(req) && Date.now() > scheduledAt(req)) return "expired";
  return "pending";
}

function accept(id){
  const profile = JSON.parse(localStorage.getItem(OBS_KEY));
  if (!profile) return alert("Save profile first");

  const map = loadStatus();
  map[id] = {
    status: "accepted",
    acceptedAt: Date.now(),
    observer: profile
  };
  saveStatus(map);
  render();
}

function render(){
  const list = document.getElementById("list");
  const reqs = loadReqs();
  const statusMap = loadStatus();
  list.innerHTML = "";

  reqs.forEach(req => {
    const state = getState(req, statusMap[req.id]);
    const sched = scheduledAt(req);

    let pill = `<span class="pill">${state.toUpperCase()}</span>`;
    if (state === "active") pill = `<span class="pill green">ACTIVE</span>`;
    if (state === "expired") pill = `<span class="pill red">EXPIRED</span>`;

    let countdown = "";
    if (state === "accepted") {
      const diff = sched - Date.now();
      const s = Math.max(0, Math.floor(diff/1000));
      countdown = `<div>Countdown: ${String(Math.floor(s/3600)).padStart(2,"0")}:${String(Math.floor((s%3600)/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}</div>`;
    }

    list.innerHTML += `
      <div class="card">
        <div style="display:flex; justify-content:space-between;">
          <b>${req.address}</b>
          ${pill}
        </div>
        <div>${req.date} ${req.displayTime || req.time}</div>
        ${countdown}
        ${
          state === "pending"
            ? `<button class="btn" onclick="accept('${req.id}')">Accept</button>`
            : ""
        }
        <button class="btn ${state !== "active" ? "disabled" : ""}"
          onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.address)}')">
          Start Assignment
        </button>
      </div>
    `;
  });
}

setInterval(render, 1000);
render();
</script>
</body>
</html>
