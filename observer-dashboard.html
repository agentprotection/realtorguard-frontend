<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Observer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-top:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
input,button{width:100%;padding:14px;margin-top:10px;border-radius:12px;font-size:16px}
button{border:none;font-weight:900;background:#111;color:#fff}
button.secondary{background:#fff;color:#111;border:1px solid #ccc}
button.disabled{opacity:.5;pointer-events:none}
img{width:90px;height:90px;border-radius:50%;object-fit:cover;margin-top:10px;border:1px solid #ccc}
</style>
</head>

<body>
<div class="wrap">

<h2>Observer Dashboard</h2>

<div class="card">
  <input id="obsName" placeholder="Name">
  <input id="obsPhone" placeholder="Phone">
  <input type="file" accept="image/*" onchange="loadPhoto(event)">
  <img id="obsPhoto">
  <button class="secondary" onclick="saveProfile()">Save Profile</button>
</div>

<div class="card">
  <div id="requestList"></div>
</div>

</div>

<script>
/* ===== STORAGE ===== */
const REQ_KEY = "rg_agent_requests_v1";
const STATUS_KEY = "rg_request_status_v3";
const OBS_KEY = "rg_observer_profile_v2";

/* ===== STATE ===== */
let photoLoaded = false;

/* ===== HELPERS ===== */
const loadReq = () => JSON.parse(localStorage.getItem(REQ_KEY)) || [];
const loadStatus = () => JSON.parse(localStorage.getItem(STATUS_KEY)) || {};
const saveStatus = s => localStorage.setItem(STATUS_KEY, JSON.stringify(s));

function scheduledAt(r){
  if(!r.date || !r.time) return null;
  return new Date(`${r.date}T${r.time}`);
}

/* ===== PHOTO ===== */
function loadPhoto(e){
  const file = e.target.files[0];
  if(!file) return;

  photoLoaded = false;
  const reader = new FileReader();
  reader.onload = () => {
    obsPhoto.src = reader.result;
    photoLoaded = true;
  };
  reader.readAsDataURL(file);
}

/* ===== PROFILE ===== */
function saveProfile(){
  if(!obsName.value || !obsPhone.value || !photoLoaded){
    alert("Upload photo and save profile first");
    return;
  }

  localStorage.setItem(OBS_KEY, JSON.stringify({
    name: obsName.value.trim(),
    phone: obsPhone.value.trim(),
    photo: obsPhoto.src
  }));

  alert("Profile saved");
}

/* ===== ACCEPT ===== */
function acceptRequest(id){
  const profile = JSON.parse(localStorage.getItem(OBS_KEY));
  if(!profile){
    alert("Save profile first");
    return;
  }

  const map = loadStatus();
  map[id] = {
    status: "accepted",
    acceptedAt: Date.now(),
    observer: profile
  };
  saveStatus(map);
  render();
}

/* ===== RENDER ===== */
function render(){
  requestList.innerHTML = "";
  const reqs = loadReq();
  const statusMap = loadStatus();

  reqs.forEach(r=>{
    const sched = scheduledAt(r);
    const stat = statusMap[r.id];
    let state = "pending";

    if(stat?.status==="accepted"){
      state = Date.now() >= sched ? "active" : "accepted";
    } else if(sched && Date.now()>sched){
      state = "expired";
    }

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <b>${r.address||""}</b>
      <div>${r.date||""} ${r.time||""}</div>
      <div>${state.toUpperCase()}</div>
    `;

    if(state==="accepted"){
      const diff = Math.max(0, sched-Date.now());
      const s = Math.floor(diff/1000);
      const h = String(Math.floor(s/3600)).padStart(2,"0");
      const m = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const sec = String(s%60).padStart(2,"0");

      const cd = document.createElement("div");
      cd.innerText = `${h}:${m}:${sec}`;
      card.appendChild(cd);
    }

    if(state==="pending"){
      const b=document.createElement("button");
      b.innerText="Accept";
      b.onclick=()=>acceptRequest(r.id);
      card.appendChild(b);
    }

    const start=document.createElement("button");
    start.innerText="Start Assignment";
    if(state!=="active") start.classList.add("disabled");
    start.onclick=()=>window.open(`https://maps.google.com?q=${encodeURIComponent(r.address||"")}`);
    card.appendChild(start);

    requestList.appendChild(card);
  });
}

setInterval(render,1000);
render();
</script>
</body>
</html>
